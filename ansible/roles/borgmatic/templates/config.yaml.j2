# Borgmatic configuration file
# See https://torsion.org/borgmatic/reference/configuration/ for full reference

# List of source directories to backup
source_directories:
{% for source in borgmatic_sources %}
  - {{ source }}
{% endfor %}

# Paths or patterns to exclude
exclude_patterns:
{% for pattern in borgmatic_exclude_patterns | default([]) %}
  - {{ pattern }}
{% endfor %}

# Repository configuration
repositories:
  - label: {{ borgmatic_repository_label | default('main') }}
    path: {{ borgmatic_repository_path }}

# Retention policy
keep_daily: {{ borgmatic_keep_daily | default(7) }}
keep_weekly: {{ borgmatic_keep_weekly | default(4) }}
keep_monthly: {{ borgmatic_keep_monthly | default(6) }}
keep_yearly: {{ borgmatic_keep_yearly | default(1) }}

# Consistency checks
checks:
  - name: repository
    frequency: {{ borgmatic_check_frequency | default('2 weeks') }}
  - name: archives
    frequency: {{ borgmatic_check_frequency | default('2 weeks') }}

# Encryption passphrase (optional, can also use BORG_PASSPHRASE env var)
{% if borgmatic_encryption_passphrase is defined %}
encryption_passphrase: {{ borgmatic_encryption_passphrase }}
{% endif %}

# Additional Borg options for create command
{% if borgmatic_compression is defined %}
compression: {{ borgmatic_compression }}
{% endif %}

# Healthcheck monitoring (optional)
{% if borgmatic_healthcheck_url is defined %}
healthchecks:
  ping_url: {{ borgmatic_healthcheck_url }}
  ping_url_states:
    - start
    - finish
{% endif %}

# Additional environment variables
{% if borgmatic_storage_s3_endpoint is defined %}
storage:
  extra_borg_options:
    create: --remote-ratelimit {{ borgmatic_remote_ratelimit | default(0) }}

# S3 backend configuration via environment variables
borgmatic_environment_variables:
  AWS_ACCESS_KEY_ID: {{ borgmatic_storage_access_key }}
  AWS_SECRET_ACCESS_KEY: {{ borgmatic_storage_secret_key }}
{% if borgmatic_storage_s3_endpoint is defined %}
  AWS_S3_ENDPOINT_URL: {{ borgmatic_storage_s3_endpoint }}
{% endif %}
{% endif %}

# Pre/post backup hooks
{% if borgmatic_before_backup is defined %}
before_backup:
{% for command in borgmatic_before_backup %}
  - {{ command }}
{% endfor %}
{% endif %}

{% if borgmatic_after_backup is defined %}
after_backup:
{% for command in borgmatic_after_backup %}
  - {{ command }}
{% endfor %}
{% endif %}
