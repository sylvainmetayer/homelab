# Borgmatic configuration for davis
# Generated from role davis templates

source_directories:
  - {{ davis_base_path }}/config
  - {{ davis_base_path }}/compose.yaml

exclude_patterns:
  - '*.log'
  - '*.tmp'
  - 'cache/*'

local_path: /root/.local/bin/borg

repositories:
  - path: {{ davis_backup_borgmatic_target }}
    label: davis-s3

encryption_passphrase: {{ davis_backup_borgmatic_password }}

compression: zstd,10

archive_name_format: 'davis_-{now:%Y-%m-%dT%H:%M:%S}'

keep_daily: 7
keep_weekly: 4
keep_monthly: 6
keep_yearly: 1

checks:
  - name: repository
    frequency: 2 weeks
  - name: archives
    frequency: 1 month

commands:
  - before: action
    when:
      - create
    run:
      - echo "Starting davis_ backup at $(date)"
  - after: action
    when:
      - create
    run:
      - echo "davis_ backup completed at $(date)"

{% if davis_backup_healthcheck_url is defined and davis_backup_healthcheck_url %}
# Uptime Kuma push
uptime_kuma:
  push_url: {{ davis_backup_healthcheck_url }}
  states:
    - start
    - finish
    - fail
{% endif %}
