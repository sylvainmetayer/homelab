name: OLM Connectivity Test

on:
  workflow_dispatch:

jobs:
  test-olm-connection:
    runs-on: ubuntu-latest

    services:
      olm:
        image: fosrl/olm
        options: >-
          --cap-add=NET_ADMIN
          --device=/dev/net/tun:/dev/net/tun
        env:
          PANGOLIN_ENDPOINT: ${{ secrets.PANGOLIN_ENDPOINT }}
          OLM_ID: ${{ secrets.OLM_ID }}
          OLM_SECRET: ${{ secrets.OLM_SECRET }}
          OVERRIDE_DNS: true

    steps:
      - name: Override DNS
        run: |
          dig @100.96.128.1 docker-apps.internal || true
          dig docker-apps.internal || true
          sudo sed -i 's/#DNS=/DNS=100.96.128.1 1.1.1.1/g' /etc/systemd/resolved.conf
          sudo systemctl daemon-reload
          sudo systemctl restart systemd-networkd
          sudo systemctl restart systemd-resolved
          sleep 5
          dig @100.96.128.1 docker-apps.internal || true
          dig docker-apps.internal || true
          ssh sylvain@docker-apps.internal -v || true

      - name: Wait for OLM to establish connection
        run: |
          echo "Waiting for OLM connection to establish..."
          sleep 10

      - name: Ping docker-apps.internal
        run: |
          echo "Attempting to ping docker-apps.internal through OLM tunnel..."
          for i in {1..10}; do
            if ping -c 3 -W 5 docker-apps.internal; then
              echo "✓ Successfully pinged docker-apps.internal"
              exit 0
            fi
            echo "Attempt $i failed, waiting 10 seconds..."
            ssh sylvain@docker-apps.internal -v || true
            sleep 5
          done
          echo "✗ Failed to ping docker-apps.internal after 10 attempts"
          exit 1
