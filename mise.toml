[tools]
opentofu = '1.11.2'
packer = 'latest'
ansible-core = 'latest'
sops = 'latest'
age = 'latest'
'github:fosrl/cli' = '0.2.1'
'github:github/copilot-cli' = '0.0.377'
uv = "latest"

[env]
# Variable are available in the tasks
_.file = { path = "secrets.sops.yaml", redact = true}

[tasks.generate_password]
description = "Generate a password, to store it in the secrets file"
usage = '''
arg "<password>" help="plain password to hash"
'''
run = 'mkpasswd --method=SHA-512 --rounds=4096 ${usage_password}'

[tasks.init]
run = "tofu init"
dir = "tofu"

[tasks.plan]
description = "Tofu Plan"
run = "tofu plan"
dir = "tofu"

[tasks.apply]
description = "Tofu Apply"
run = "tofu apply"
raw = true
dir = "tofu"

[tasks.lint]
description = "Tofu linting"
run = "tofu fmt -check && tofu validate"
dir = "tofu"
depends = "init"

[tasks.fix-lint]
description = "Tofu linting fix"
run = "tofu fmt"
dir = "tofu"
depends = "init"

[tasks.get_state]
description = "Get the current state of the tofu deployment"
run = "tofu state pull > state.json"
dir = "tofu"

[tasks.packer-init]
description = "Initialize Packer plugins"
run = "packer init ."
dir = "packer/pangolin"

[tasks.packer-validate]
description = "Validate Packer configuration"
run = "packer validate ."
dir = "packer/pangolin"
depends = "packer-init"

[tasks.packer-build]
description = "Build Pangolin image with Packer"
run = "packer build ."
dir = "packer/pangolin"
depends = "packer-init"
raw = true
